---
title: "Introducing pataqu"
author: Vincent Bonhomme, Allowen Evin
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r prelim, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

pataqu aims at visualizing and testing the effect of uncertainties on x values (ie the independant variable). This vignette quickly presents the rationale of the package then jump to a case study.

## Rationale

### Sources of uncertainties
We chiefly had in mind archaeological data which dating of remains are often temporally bounded between two certain events, named _terminus post/ante quem_, further abbreviated tpq and taq^[hence the package name which is also a delicate pun, in French]. The tpq is the earliest date, the taq the latest.

The _real_ event may have happened anytime between these two boundaries with a flat, uniform, density of probability along the interval.

We can also think of radiocarbon dating, which comes with a prediction and a confidence interval (say $\mu Â± \sigma$). But here the dating differ and the _real_ event has a  density of probability of gaussian nature with parameters $\mu$ and $\sigma$.

### Consequences and how to inspect them
Whatever the source of the uncertainty, the graphics, tests and overall stories we can obtain from data may well be affected. How robust your lovely trends to temporal uncertainties?

pataqu aims at visualizing and testing this using permutations. This is not the only way to do it but in our view it has the merit to only use information contained in the data itself.

The idea is:

1. Simulate plausible new x values
2. Display and/or test what you need
3. Repeat many times and see what happens

## Case study: taq and ptq

We will load the package and also use `dplyr` and `ggplot2` from the [tidyverse](tidyverse.org/). Overall, if you `library(tidyverse)` you should not need much more^[and typically you will not need to `dplyr::` or `ggplot2::` like what you have in function examples.]

```{r setup, message=FALSE, }
library(dplyr)
library(ggplot2)
library(pataqu)
```

### `animals` dataset

This dataset is made of real (and unpublished) data where researchers measured a `value` of interest on archaeological remains, in several `sites` (with `us` or stratigraphical units in them), dated with `tpq` and `taq`. The remains belonged to four `taxa`.

```{r animals_head}
head(animals)
# We only show the first lines but you can View(animals)
```
How would we treat that? We could decide to display the full interval and see what happens:

```{r gg_errorh }
# pure cosmetics for lighter graphs
theme_set(theme_minimal())

animals %>% ggplot() +
 geom_errorbarh(aes(xmin=tpq, xmax=taq, y=value, col=taxa), size=0.2, alpha=0.5)
```

What a mess! We could try to add a mid point and add a smoother on top of them.

```{r gg_mid1}
animals %>% 
  mutate(x_new=(tpq+taq)/2) %>% 
  ggplot() +
  aes(x=x_new, y=value, col=taxa) +
  geom_point(size=0.1) +
  geom_smooth(method="loess", formula="y~x", se=FALSE) -> gg_mid
gg_mid
```
We now are able to see some trends but we lost the uncertainty on x in the meantime.
The graph before may have also been the one below, with the same likelihood.

We take animals and simply draw other `x_new` values, not on the midpoint, somewhere between the tpq and taq of each line. We use `set.seed` for the sake of replicability only.

```{r gg_mid_animals2}
set.seed(2329)
# lets draw new x values
animals2 <- animals %>%
    dplyr::rowwise() %>%
    dplyr::mutate(x_new=stats::runif(n=1, min=tpq, max=taq)) %>%
    dplyr::ungroup()
# and redo gg_mid graph with this new tibble
gg_mid %+% animals2
```

Same same but different.

The code used above is exactly what `shake_uniform` is made of behind the curtain^[check by yourself and type `pataqu::shake_uniform` (no brackets) in the console].

pataqu generalizes this idea with a little decoration around this pattern.

The mother function is
We will simulate 5 new datasets with randomized datations. The true dates can be anytime between ptq and taq. We use `quake_uniform`.
```{r quake1}
a_q <- animals %>% 
  quake_uniform(tpq=tpq, taq=taq, y=value, k=5, group=taxa)
```
<!-- <!-- -->
<!-- Let's have a look to the results: -->
<!-- ```{r} -->
<!-- a_q -->
<!-- # spaghetti(a_q) -->
<!-- ``` -->
<!-- One can now test _globally_ when patterns between taxa differ: -->

<!-- ```{r} -->
<!-- res_global <- a_q %>% synchrony() -->
<!-- res_global %>% filter(p<1e-4) -->
<!-- ``` -->

<!-- But also test for pairwise differences: -->
<!-- ```{r} -->
<!-- res <- a_q %>% synchrony_pw() -->
<!-- head(res) -->
<!-- ``` -->

<!-- And we can also check only those that differ: -->

<!-- ```{r} -->
<!--  res %>% filter(p<0.0001) -->
<!-- ``` -->

<!-- --> -->

